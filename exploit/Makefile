AS       := nasm

SRCS     := $(wildcard *.c)
TARGET   := $(SRCS:.c=.elf)

SUB_OBJS := utils/utils.a

CFLAGS   := -Wall -masm=intel -fno-stack-protector -fPIE
LDFLAGS  := -nostdlib -no-pie

ifndef SYS_HANDLER
SYS_HANDLER := 0x17cb
endif

export CFLAGS

.PHONY: all
all: $(TARGET)

%.elf: start.o %.c $(SUB_OBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o $@ -DOFST_SYS_HANDLER=$(SYS_HANDLER)
	strip $@

%.o: %.s
	$(AS) -f elf64 $^

$(SUB_OBJS): FORCE
	$(MAKE) -C $(dir $@) $(notdir $@)

.PHONY: clean
clean:
	dirname $(SUB_OBJS) | xargs -l $(MAKE) clean -C
	$(RM) $(TARGET)

FORCE:
