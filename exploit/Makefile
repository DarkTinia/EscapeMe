SRCS     := $(wildcard *.c)
TARGET   := $(SRCS:.c=.elf)

SUB_OBJS := utils/utils.a

CFLAGS   := -Wall -masm=intel -fno-stack-protector
LDFLAGS  := -nostdlib -no-pie
AS       := nasm

.PHONY: all
all: $(TARGET)

%.elf: start.o %.c $(SUB_OBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o $@

%.o: %.s
	$(AS) -f elf64 $^

$(SUB_OBJS): FORCE
	$(MAKE) -C $(dir $@) CFLAGS="$(CFLAGS)" $(notdir $@)

.PHONY: clean
clean:
	dirname $(SUB_OBJS) | xargs -l $(MAKE) clean -C
	$(RM) $(TARGET)

FORCE:
